<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Scheduler</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #000;
            text-align: center;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        .header-buttons {
            margin-bottom: 20px;
        }
        .blocked {
            background-color: #f00;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>Generador de Turnos</h1>
    <div class="header-buttons">
        <button onclick="generateShifts()">Generar Turnos</button>
        <button onclick="intelligentAssignment()">Asignaci√≥n Inteligente</button>
        <button onclick="clearShifts()">Limpiar Turnos</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Trabajador</th>
            </tr>
        </thead>
        <tbody id="shift-table-body">
            <!-- Rows will be populated by JavaScript -->
        </tbody>
    </table>

    <script>
const despachadores = [
    "Despachador 1",
    "Despachador 2",
    "Despachador 3",
    "Despachador 4",
    "Despachador 5",
    "Despachador 6",
    "Despachador 7",
    "Despachador 8",
    "Despachador 9",
    "Despachador 10",
    "Despachador 11",
    "Despachador 12",
    "Despachador 13",
    "Despachador 14",
    "Despachador 15"
];
        const shiftManagers = [
            "JT1", "JT2", "JT3", "JT4"
        ];
        const totalDays = 31;
        const shiftTableBody = document.getElementById('shift-table-body');

        function createTable() {
            // Create header dynamically
            const headerRow = document.querySelector('thead tr');
            for (let i = 1; i <= totalDays; i++) {
                const th = document.createElement('th');
                th.textContent = i;
                headerRow.appendChild(th);
            }

            const workers = [...dispatchers, ...shiftManagers];
            workers.forEach(worker => {
                const row = document.createElement('tr');
                const workerCell = document.createElement('td');
                workerCell.textContent = worker;
                row.appendChild(workerCell);

                for (let i = 1; i <= totalDays; i++) {
                    const dayCell = document.createElement('td');
                    const select = document.createElement('select');
                    select.oncontextmenu = (event) => {
                        event.preventDefault();
                        toggleBlock(event.target);
                    };
                    ["L", "M", "T", "N"].forEach(shift => {
                        const option = document.createElement('option');
                        option.value = shift;
                        option.textContent = shift;
                        select.appendChild(option);
                    });
                    dayCell.appendChild(select);
                    row.appendChild(dayCell);
                }
                shiftTableBody.appendChild(row);
            });
        }

        function toggleBlock(select) {
            if (select.classList.contains('blocked')) {
                select.classList.remove('blocked');
                select.disabled = false;
            } else {
                select.classList.add('blocked');
                select.disabled = true;
            }
        }

        function clearShifts() {
            document.querySelectorAll('select').forEach(select => {
                if (!select.classList.contains('blocked')) {
                    select.value = 'L';
                }
            });
        }

        function intelligentAssignment() {
            clearShifts();
            let nightShiftIndex = 0;

            for (let day = 1; day <= totalDays; day++) {
                assignShifts(day, "M", 7, 2); // Morning shifts
                assignShifts(day, "T", 4, 1); // Afternoon shifts

                if (day % 7 === 1) {
                    nightShiftIndex = assignNightShift(day, nightShiftIndex);
                }
            }

            ensureWorkDays();
        }

        function assignShifts(day, shiftType, numDispatchers, numManagers) {
            const dayIndex = day - 1;
            const dispatchersAssigned = getRandomElements(dispatchers, numDispatchers);
            const managersAssigned = getRandomElements(shiftManagers, numManagers);

            dispatchersAssigned.forEach(dispatcher => {
                const select = getSelectElement(dispatcher, dayIndex);
                if (select && !select.classList.contains('blocked')) {
                    select.value = shiftType;
                }
            });
            managersAssigned.forEach(manager => {
                const select = getSelectElement(manager, dayIndex);
                if (select && !select.classList.contains('blocked')) {
                    select.value = shiftType;
                }
            });
        }

        function assignNightShift(startDay, currentNightShiftIndex) {
            const dispatcher = dispatchers[currentNightShiftIndex];
            const preDaysOff = 2;
            const postDaysOff = 3;

            // Assign days off before the night shift
            for (let i = 0; i < preDaysOff; i++) {
                if ((startDay - preDaysOff + i) >= 1) {
                    const select = getSelectElement(dispatcher, startDay - preDaysOff + i - 1);
                    if (select && !select.classList.contains('blocked')) {
                        select.value = 'L';
                    }
                }
            }

            // Assign night shift
            for (let i = 0; i < 1 && (startDay + i) <= totalDays; i++) {
                const select = getSelectElement(dispatcher, startDay + i - 1);
                if (select && !select.classList.contains('blocked')) {
                    select.value = "N";
                }
            }

            // Assign days off after the night shift
            for (let i = 0; i < postDaysOff; i++) {
                if ((startDay + 1 + i) <= totalDays) {
                    const select = getSelectElement(dispatcher, startDay + 1 + i - 1);
                    if (select && !select.classList.contains('blocked')) {
                        select.value = 'L';
                    }
                }
            }

            currentNightShiftIndex++;
            if (currentNightShiftIndex >= dispatchers.length) {
                currentNightShiftIndex = 0;
            }
            return currentNightShiftIndex;
        }

        function getSelectElement(worker, dayIndex) {
            const row = Array.from(shiftTableBody.children).find(row => row.children[0].textContent === worker);
            return row ? row.children[dayIndex + 1].querySelector('select') : null;
        }

        function getRandomElements(array, numElements) {
            const shuffled = array.slice().sort(() => 0.5 - Math.random());
            return shuffled.slice(0, numElements);
        }

        function ensureWorkDays() {
            dispatchers.forEach(dispatcher => {
                const workDays = Array.from(shiftTableBody.children)
                    .find(row => row.children[0].textContent === dispatcher)
                    .querySelectorAll('select')
                    .filter(select => select.value !== 'L' && !select.classList.contains('blocked')).length;

                const daysNeeded = 20 - workDays;
                if (daysNeeded > 0) {
                    let day = 1;
                    while (day <= totalDays && daysNeeded > 0) {
                        const select = getSelectElement(dispatcher, day - 1);
                        if (select && select.value === 'L' && !select.classList.contains('blocked')) {
                            select.value = 'M'; // Default to morning shift
                            daysNeeded--;
                        }
                        day++;
                    }
                }
            });

            shiftManagers.forEach(manager => {
                const workDays = Array.from(shiftTableBody.children)
                    .find(row => row.children[0].textContent === manager)
                    .querySelectorAll('select')
                    .filter(select => select.value !== 'L' && !select.classList.contains('blocked')).length;

                const daysNeeded = 20 - workDays;
                if (daysNeeded > 0) {
                    let day = 1;
                    while (day <= totalDays && daysNeeded > 0) {
                        const select = getSelectElement(manager, day - 1);
                        if (select && select.value === 'L' && !select.classList.contains('blocked')) {
                            select.value = 'M'; // Default to morning shift
                            daysNeeded--;
                        }
                        day++;
                    }
                }
            });
        }

        window.onload = createTable;
    </script>
</body>
</html>
