<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generador de Turnos Inteligente</title>
    <style>
        /* ... estilos CSS ... */
    </style>
</head>
<body>
    <h1>Generador de Turnos</h1>
    <div class="header-buttons">
        <button onclick="generateShifts()">Generar Turnos</button>
        <button onclick="intelligentAssignment()">Asignación Inteligente</button>
        <button onclick="clearShifts()">Limpiar Turnos</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Trabajador</th>
                <!-- Celdas de encabezado para los días -->
            </tr>
        </thead>
        <tbody id="shift-table-body">
            <!-- Filas generadas dinámicamente -->
        </tbody>
    </table>

    <script>
        const despachadores = [
            "Despachador 1",
            "Despachador 2",
            "Despachador 3",
            "Despachador 4",
            "Despachador 5",
            "Despachador 6",
            "Despachador 7",
            "Despachador 8",
            "Despachador 9",
            "Despachador 10",
            "Despachador 11",
            "Despachador 12",
            "Despachador 13",
            "Despachador 14",
            "Despachador 15"
        ];

        const shiftManagers = [
            "JT1", "JT2", "JT3", "JT4"
        ];

        const totalDays = 31;
        const shiftTableBody = document.getElementById('shift-table-body');

        function createTable() {
            // Crear encabezado dinámicamente
            const headerRow = document.querySelector('thead tr');
            for (let i = 1; i <= totalDays; i++) {
                const th = document.createElement('th');
                th.textContent = i;
                headerRow.appendChild(th);
            }

            const workers = [...despachadores, ...shiftManagers];
            workers.forEach(worker => {
                const row = document.createElement('tr');
                const workerCell = document.createElement('td');
                workerCell.textContent = worker;
                row.appendChild(workerCell);

                for (let i = 1; i <= totalDays; i++) {
                    const dayCell = document.createElement('td');
                    const select = document.createElement('select');
                    select.oncontextmenu = (event) => {
                        event.preventDefault();
                        toggleBlock(event.target);
                    };
                    ["L", "M", "T", "N"].forEach(shift => {
                        const option = document.createElement('option');
                        option.value = shift;
                        option.textContent = shift;
                        select.appendChild(option);
                    });
                    dayCell.appendChild(select);
                    row.appendChild(dayCell);
                }
                shiftTableBody.appendChild(row);
            });
        }

        function toggleBlock(select) {
            if (select.classList.contains('blocked')) {
                select.classList.remove('blocked');
                select.disabled = false;
            } else {
                select.classList.add('blocked');
                select.disabled = true;
            }
        }

        function clearShifts() {
            document.querySelectorAll('select').forEach(select => {
                if (!select.classList.contains('blocked')) {
                    select.value = 'L';
                }
            });
        }

        function intelligentAssignment() {
            clearShifts();

            // Inicializar disponibilidad
            let dispatcherAvailability = {};
            despachadores.forEach(dispatcher => {
                dispatcherAvailability[dispatcher] = new Array(totalDays).fill(true);
            });

            const nightShiftStartDays = [1, 7, 13, 19, 25]; // Días de inicio para turnos de noche
            let nightShiftIndex = 0;

            for (let day = 1; day <= totalDays; day++) {
                const dayIndex = day - 1;

                // Asignar turnos de mañana y tarde
                assignShifts(day, "M", 7, 2, dispatcherAvailability);
                assignShifts(day, "T", 4, 1, dispatcherAvailability);

                // Asignar turno de noche
                if (nightShiftStartDays.includes(day)) {
                    nightShiftIndex = assignNightShift(day, nightShiftIndex, dispatcherAvailability);
                }
            }

            ensureWorkDays(dispatcherAvailability);
        }

        function assignShifts(day, shiftType, numDispatchers, numManagers, dispatcherAvailability) {
            const dayIndex = day - 1;
            const availableDispatchers = despachadores.filter(dispatcher => dispatcherAvailability[dispatcher][dayIndex]);
            const dispatchersAssigned = getRandomElements(availableDispatchers, Math.min(numDispatchers, availableDispatchers.length));
            const managersAssigned = getRandomElements(shiftManagers, numManagers);

            dispatchersAssigned.forEach(dispatcher => {
                const select = getSelectElement(dispatcher, dayIndex);
                if (select && !select.classList.contains('blocked')) {
                    select.value = shiftType;
                    dispatcherAvailability[dispatcher][dayIndex] = false;
                }
            });
            managersAssigned.forEach(manager => {
                const select = getSelectElement(manager, dayIndex);
                if (select && !select.classList.contains('blocked')) {
                    select.value = shiftType;
                }
            });
        }

        function assignNightShift(startDay, currentNightShiftIndex, dispatcherAvailability) {
            const dispatcher = despachadores[currentNightShiftIndex];
            const preDaysOff = 1;
            const nightShiftDays = 3;
            const postDaysOff = 2;

            // Día libre antes del turno de noche
            let dayIndex = startDay - 1 - preDaysOff;
            if (dayIndex >= 0) {
                const select = getSelectElement(dispatcher, dayIndex);
                if (select && !select.classList.contains('blocked')) {
                    select.value = 'L';
                    dispatcherAvailability[dispatcher][dayIndex] = false;
                }
            }

            // Asignar turnos de noche
            for (let i = 0; i < nightShiftDays && (startDay + i) <= totalDays; i++) {
                dayIndex = startDay + i - 1;
                const select = getSelectElement(dispatcher, dayIndex);
                if (select && !select.classList.contains('blocked')) {
                    select.value = "N";
                    dispatcherAvailability[dispatcher][dayIndex] = false;
                }
            }

            // Días libres después del turno de noche
            for (let i = 0; i < postDaysOff; i++) {
                dayIndex = startDay + nightShiftDays + i - 1;
                if (dayIndex < totalDays) {
                    const select = getSelectElement(dispatcher, dayIndex);
                    if (select && !select.classList.contains('blocked')) {
                        select.value = 'L';
                        dispatcherAvailability[dispatcher][dayIndex] = false;
                    }
                }
            }

            currentNightShiftIndex = (currentNightShiftIndex + 1) % despachadores.length;
            return currentNightShiftIndex;
        }

        function getSelectElement(worker, dayIndex) {
            const row = Array.from(shiftTableBody.children).find(row => row.children[0].textContent === worker);
            return row ? row.children[dayIndex + 1].querySelector('select') : null;
        }

        function getRandomElements(array, numElements) {
            const shuffled = array.slice().sort(() => 0.5 - Math.random());
            return shuffled.slice(0, numElements);
        }

        function ensureWorkDays(dispatcherAvailability) {
            despachadores.forEach(dispatcher => {
                const row = Array.from(shiftTableBody.children).find(row => row.children[0].textContent === dispatcher);
                const selects = row.querySelectorAll('select');
                let workDays = 0;
                selects.forEach((select, dayIndex) => {
                    if (select.value !== 'L' && !select.classList.contains('blocked')) {
                        workDays++;
                    }
                });

                let daysNeeded = 20 - workDays;
                if (daysNeeded > 0) {
                    for (let dayIndex = 0; dayIndex < totalDays && daysNeeded > 0; dayIndex++) {
                        const select = selects[dayIndex];
                        if (dispatcherAvailability[dispatcher][dayIndex] && select.value === 'L' && !select.classList.contains('blocked')) {
                            select.value = 'M'; // Asignar turno de mañana por defecto
                            dispatcherAvailability[dispatcher][dayIndex] = false;
                            daysNeeded--;
                        }
                    }
                }
            });

            shiftManagers.forEach(manager => {
                const row = Array.from(shiftTableBody.children).find(row => row.children[0].textContent === manager);
                const selects = row.querySelectorAll('select');
                let workDays = 0;
                selects.forEach(select => {
                    if (select.value !== 'L' && !select.classList.contains('blocked')) {
                        workDays++;
                    }
                });

                let daysNeeded = 20 - workDays;
                if (daysNeeded > 0) {
                    for (let dayIndex = 0; dayIndex < totalDays && daysNeeded > 0; dayIndex++) {
                        const select = selects[dayIndex];
                        if (select.value === 'L' && !select.classList.contains('blocked')) {
                            select.value = 'M'; // Asignar turno de mañana por defecto
                            daysNeeded--;
                        }
                    }
                }
            });
        }

        window.onload = createTable;
    </script>
</body>
</html>
